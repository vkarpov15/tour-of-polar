<!DOCTYPE html>
<html lang="en">

<head>
  <!-- favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="https://cdn.prod.website-files.com/5f148310b9588c295ed77f20/6222613fc7d2ef9b8b5312f8_logo-black.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://cdn.prod.website-files.com/5f148310b9588c295ed77f20/6222613fc7d2ef9b8b5312f8_logo-black.png">

  <title>A Tour of Polar</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://unpkg.com/codemirror@5.65.16/lib/codemirror.css">
  <script src="https://unpkg.com/codemirror@5.65.16/lib/codemirror.js"></script>
  <script src="https://unpkg.com/codemirror@5.65.16/mode/ruby/ruby.js"></script>
  <script src="content.js"></script>

  <style>
    .CodeMirror { height: 100%; }
    #drag-bar {
      padding: 3px;
      cursor: row-resize;
      background-color: silver;
    }
  </style>

  <link rel="stylesheet" href="tw.css" />
</head>

<body>

  <div class="flex flex-col h-screen w-screen">
    <header class="bg-indigo-600 text-white">
      <div class="px-4 py-2">
        <h1 class="text-2xl font-bold"><img src="https://www.osohq.com/docs/logo-bear-white.png" class="inline h-[1em] mr-1"> A Tour of Polar</h1>
      </div>
    </header>
    <div class="flex flex-1 w-screen">
      <div class="w-1/2 border-r border-gray-100 p-4 flex flex-col gap-6">
        <div id="pageContent" class="flex-grow"></div>
        <div class="w-full flex gap-4 items-center">
          <button onclick="previousPage()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-md">&lt;</button>
          <span class="text-gray-600" id="curPage">${currentPage + 1} / ${content.length}</span>
          <button onclick="nextPage()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-md">&gt;</button>
        </div>
      </div>
      <div class="w-1/2 flex flex-col h-[calc(100vh-48px)] overflow-hidden">
        <div id="editor" class="h-1/2"></div>
        <div id="drag-bar"></div>
        <div class="w-full h-1/2">
          <div class="w-full bg-gray-100 p-3 flex justify-between">
            <button id="runButton" onclick="runCode()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-md disabled:bg-slate-500">Run</button>
          </div>
          <pre id="results" class="p-4 h-[calc(100%-64px)] overflow-y-auto"></pre>
        </div>
      </div>
    </div>
  </div>
</body>

<script>
let currentPage = 0;

function previousPage() {
  if (currentPage > 0) {
    currentPage--;
    cm.setValue(content[currentPage].code);
    document.getElementById('pageContent').innerHTML = content[currentPage].text;
    updatePageDisplay();
    history.pushState(null, '', currentPage === 0 ? '/' : `/${currentPage + 1}`);
  }
}

function nextPage() {
  if (currentPage < content.length - 1) {
    currentPage++;
    cm.setValue(content[currentPage].code.trim());
    document.getElementById('pageContent').innerHTML = content[currentPage].text;
    updatePageDisplay();
    history.pushState(null, '', `/${currentPage + 1}`);
  }
}

function updatePageDisplay() {
  document.querySelector('#curPage').textContent = `${currentPage + 1} / ${content.length}`;
}

async function runCode() {
  const runButton = document.getElementById('runButton');
  runButton.disabled = true;
  const code = cm.getValue();
  const results = document.getElementById('results');
  try {
    results.innerHTML = '<div class="animate-spin h-5 w-5 border-2 border-indigo-600 border-t-transparent rounded-full mx-auto"></div>';
    const response = await fetch('/api/exec', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ code })
    });
    const result = await response.json();
    let displayResult = 'Policy executed successfully';
    if (result.error) {
      try {
        const data = JSON.parse(result.error.slice(result.error.indexOf('['), result.error.lastIndexOf(']') + 1));
        displayResult = data.map(err => err.error_type + ': ' + err.message).join('\n\n');
      } catch(err) {
        displayResult = result.error;
      }
    }
    results.textContent = displayResult;
  } catch (error) {
    results.textContent = 'Error: ' + error.message;
  } finally {
    runButton.disabled = false;
  }
}

// Get page from URL
const path = window.location.pathname;
currentPage = path === '/' ? 0 : parseInt(path.slice(1)) - 1;
if (Number.isNaN(currentPage)) {
  currentPage = 0;
}

// Initialize page display and content
document.getElementById('pageContent').innerHTML = content[currentPage].text;
updatePageDisplay();

// Set initial URL
history.replaceState(null, '', currentPage === 0 ? '/' : `/${currentPage + 1}`);

var cm = CodeMirror(document.getElementById("editor"), {
  value: content[currentPage].code.trim(),
  lineNumbers: true,
  lineWrapping: true,
  tabSize: 2,
  autofocus: true,
  mode: "ruby"
});

// Drag bar functionality
window.addEventListener('DOMContentLoaded', () => {
  const dragBar = document.getElementById('drag-bar');
  const editorDiv = document.getElementById('editor');
  const resultsDiv = document.getElementById('results').parentElement;
  let isDragging = false;
  let initialMouseY = 0;
  let initialEditorHeight = 0;

  dragBar.addEventListener('mousedown', (e) => {
    e.preventDefault();
    isDragging = true;
    initialMouseY = e.clientY || e.pageY;
    initialEditorHeight = editorDiv.offsetHeight;
  });

  document.addEventListener('mousemove', (e) => {
    if (isDragging) {
      const mouseY = e.clientY || e.pageY;
      const containerTop = editorDiv.parentElement.offsetTop;
      const containerHeight = editorDiv.parentElement.offsetHeight;

      const mouseMovementY = mouseY - initialMouseY;
      const newEditorHeight = Math.max(initialEditorHeight + mouseMovementY, 0);

      const editorHeight = (newEditorHeight / containerHeight) * 100;
      const resultsHeight = 100 - editorHeight;

      editorDiv.style.height = `${editorHeight}%`;
      resultsDiv.style.height = `${resultsHeight}%`;
      cm.refresh();
    }
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
  });
});
</script>

</html>
